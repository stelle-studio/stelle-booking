<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stelle studio 預約系統</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        /* ... 樣式區保持不變 ... */
        :root { --primary-brown: #8D6E63; --bg-color: #F8F6F3; --card-white: #FFFFFF; --text-dark: #5D4037; --text-light: #8D6E63; --accent-bar: #795548; --input-bg: #FCFBF9; --input-border: #E8E0DD; }
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: var(--text-dark); margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .container { background-color: var(--card-white); width: 100%; max-width: 480px; padding: 40px 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(93, 64, 55, 0.08); display: flex; flex-direction: column; align-items: center; }
        .brand-title { font-family: 'Cormorant Garamond', serif; font-size: 38px; font-weight: 600; color: var(--text-dark); margin: 0 0 5px 0; letter-spacing: 1px; }
        .sub-title { font-size: 14px; color: var(--text-light); font-weight: 500; margin-bottom: 30px; letter-spacing: 3px; text-transform: uppercase; }
        #loading-status { font-size: 14px; color: var(--text-light); margin-top: 20px; text-align: center; }
        .section-block { display: none; width: 100%; text-align: center; animation: fadeIn 0.8s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .user-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--bg-color); box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .greeting { font-size: 16px; color: var(--text-dark); margin-bottom: 25px; }
        .greeting span { font-weight: 500; color: var(--primary-brown); }
        .form-group { text-align: center; margin-bottom: 20px; }
        label { display: block; font-size: 14px; color: var(--text-light); margin-bottom: 8px; font-weight: 500; text-align: left; padding-left: 5px; }
        input, select { width: 100%; padding: 12px 15px; border: 1px solid var(--input-border); background-color: var(--input-bg); border-radius: 8px; font-size: 16px; color: var(--text-dark); outline: none; transition: all 0.3s ease; appearance: none; text-align: center; text-align-last: center; }
        input:disabled, select:disabled { background-color: #EFEBE9; color: #8D6E63; cursor: not-allowed; border-color: #E0E0E0; }
        select { background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238D6E63' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 15px center; background-size: 16px; }
        input:focus, select:focus { border-color: var(--primary-brown); background-color: #fff; box-shadow: 0 0 0 3px rgba(141, 110, 99, 0.1); }
        
        .btn-submit { background-color: var(--primary-brown); color: white; border: none; padding: 15px; width: 100%; font-size: 16px; border-radius: 8px; cursor: pointer; margin-top: 15px; letter-spacing: 1.5px; transition: background 0.3s; font-weight: 500; }
        .btn-submit:hover { background-color: var(--accent-bar); }
        .btn-outline { background-color: transparent; color: var(--primary-brown); border: 1px solid var(--primary-brown); margin-top: 10px; }
        .btn-outline:hover { background-color: #FDF3F0; }
        .btn-submit:disabled { background-color: #ccc; cursor: not-allowed; }
        .debug-info { font-size: 10px; color: #E0E0E0; margin-top: 30px; word-break: break-all; }
        
        .details-card { background: #FAFAFA; border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: left; border: 1px solid #EFEFEF; }
        .details-row { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px dashed #E0E0E0; padding-bottom: 8px; }
        .details-row:last-child { border-bottom: none; }
        .d-label { color: var(--text-light); font-size: 14px; }
        .d-value { color: var(--text-dark); font-weight: 600; font-size: 15px; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .custom-modal { background: #fff; width: 85%; max-width: 360px; padding: 30px 25px; border-radius: 16px; text-align: center; }
        .modal-title { font-size: 18px; color: var(--primary-brown); font-weight: 600; margin-bottom: 20px; }
        .btn-modal-close { background-color: var(--primary-brown); color: white; border: none; padding: 12px 0; width: 100%; border-radius: 6px; cursor: pointer; }
        .reminder-text { font-size: 13px; color: var(--primary-brown); margin-top: 12px; margin-bottom: 5px; font-weight: 500; }

        .service-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
        .service-select { flex: 1; }
        /* 讓 placeholder 顏色變淡 (選擇性) */
        .service-select:invalid { color: #D7CCC8; }
        .btn-add { background-color: #EFEBE9; color: var(--primary-brown); border: 1px dashed var(--primary-brown); border-radius: 8px; padding: 10px; width: 100%; cursor: pointer; font-size: 14px; transition: 0.3s; margin-bottom: 10px; }
        .btn-add:hover { background-color: #FDF3F0; }
        .btn-remove { background: none; border: none; color: #F44336; font-size: 20px; cursor: pointer; padding: 0 5px; line-height: 1; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="brand-title">Stelle studio</h1>
        <h2 class="sub-title">蒔黛美學 線上預約</h2>
        <div id="loading-status">LINE 系統連線中...</div>

        <div id="booking-form-section" class="section-block">
            <img id="userPicture" class="user-avatar" src="" alt="User">
            <p class="greeting">您好，<span id="userName"></span></p>
            <form id="bookingForm" onsubmit="event.preventDefault(); submitBooking();">
                <div class="form-group"><label>預約姓名</label><input type="text" id="inputName" placeholder="請輸入姓名" required></div>
                <div class="form-group"><label>聯絡電話</label><input type="tel" id="inputPhone" placeholder="09xx-xxx-xxx" required></div>
                
                <!-- 動態服務項目 -->
                <div class="form-group">
                    <label>服務項目</label>
                    <div id="serviceContainer">
                        <!-- JS 自動產生 -->
                    </div>
                    <button type="button" class="btn-add" id="btnAddService" onclick="addServiceRow()">+ 新增服務項目</button>
                </div>

                <div class="form-group"><label>選擇據點</label>
                    <select id="inputLocation">
                        <option value="桃園店 (桃園區南海街)">桃園店 (桃園區南海街)</option>
                        <option value="中壢店 (中壢區後寮一路)">中壢店 (中壢區後寮一路)</option>
                    </select>
                </div>

                <div class="form-group"><label>期望日期</label><input type="date" id="inputDate" required></div>
                <div class="form-group"><label>期望時間</label><select id="inputTime" required></select><p class="reminder-text">送出不代表預約成功，請靜待預約成功訊息通知</p></div>
                <button type="submit" id="submitBtn" class="btn-submit">確認預約</button>
                <div class="debug-info">User ID: <span id="userIdText"></span></div>
            </form>
        </div>

        <div id="booking-details-section" class="section-block">
            <h3 style="font-size:18px; margin-bottom:20px; color:var(--text-dark);">目前預約詳情</h3>
            <div class="details-card">
                <div class="details-row"><span class="d-label">姓名</span><span class="d-value" id="viewName"></span></div>
                <div class="details-row"><span class="d-label">服務項目</span><span class="d-value" id="viewService" style="text-align:right; white-space: pre-wrap;"></span></div>
                <div class="details-row"><span class="d-label">據點</span><span class="d-value" id="viewLocation"></span></div>
                <div class="details-row"><span class="d-label">預約時間</span><span class="d-value" id="viewTime"></span></div>
            </div>
            <button id="btn-modify-booking" onclick="switchToEditMode()" class="btn-submit">修改預約時段</button>
            <button onclick="liff.closeWindow()" class="btn-submit btn-outline">關閉視窗</button>
        </div>
    </div>

    <div id="customModal" class="modal-overlay">
        <div class="custom-modal">
            <div class="modal-title">感謝您的預約！<br>請靜待確認通知</div>
            <div class="details-card" style="background:var(--bg-color); border:none;">
                <div class="details-row"><span class="d-label">姓名：</span><span class="d-value" id="modalName"></span></div>
                <div class="details-row"><span class="d-label">項目：</span><span class="d-value" id="modalService" style="text-align:right; white-space: pre-wrap;"></span></div>
                <div class="details-row"><span class="d-label">據點：</span><span class="d-value" id="modalLocation"></span></div>
                <div class="details-row"><span class="d-label">日期：</span><span class="d-value" id="modalDate"></span></div>
                <div class="details-row"><span class="d-label">時間：</span><span class="d-value" id="modalTime"></span></div>
            </div>
            <button class="btn-modal-close" onclick="closeModal()">關閉</button>
        </div>
    </div>

    <script>
        const YOUR_LIFF_ID = '2008676848-7eEjQ8U9'; 
        // ★★★ 請務必確認這裡的網址是您最新的 Apps Script 部署網址 ★★★
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzFZMsvRXC1Muvh6J2vcOTErZPpYPJgTezDEoeDPUDf1bQQgVkzbdJPNQ_Pe9PXEdSRQA/exec'; 

        const serviceOptions = [
            "粉黛柔霧眉 $7,990",
            "立體野生眉 $9,990",
            "野生粉黛眉 $13,990",
            "輕染潤霧唇 $13,990",
            "還原潤色唇 $16,990",
            "唇淡色還原 $5,990",
            "韓式睫毛管理 $1,290",
            "單次微創洗眉 $1,990",
            "無限包套優惠 $8,990",
            "－",
            "3 個月內補色 $0",
            "超過 3 個月補色 $半價",
            "包套睫毛回訪 $0",
            "包套除色回訪 $0"
        ];

        // ★★★ 定義互斥群組 ★★★
        const conflictGroups = [
            // 群組 1: 眉毛與除色相關 (只能選一個)
            [
                "粉黛柔霧眉 $7,990",
                "立體野生眉 $9,990",
                "野生粉黛眉 $13,990",
                "單次微創洗眉 $1,990",
                "無限包套優惠 $8,990",
                "3 個月內補色 $0",
                "超過 3 個月補色 $半價",
                "包套除色回訪 $0"
            ],
            // 群組 2: 唇部相關 (只能選一個)
            [
                "輕染潤霧唇 $13,990",
                "還原潤色唇 $16,990",
                "唇淡色還原 $5,990",
                "3 個月內補色 $0",
                "超過 3 個月補色 $半價"
            ],
            // 群組 3: 睫毛相關 (只能選一個)
            [
                "韓式睫毛管理 $1,290",
                "包套睫毛回訪 $0"
            ]
        ];

        function initTimeSlots() {
            const select = document.getElementById('inputTime');
            const startHour = 10; const endHour = 20;   
            for (let h = startHour; h <= endHour; h++) {
                let hourStr = h.toString().padStart(2, '0');
                select.add(new Option(`${hourStr}:00`, `${hourStr}:00`));
                if (h !== endHour) select.add(new Option(`${hourStr}:30`, `${hourStr}:30`));
            }
        }

        // --- 動態新增服務功能 (更新版) ---
        function createServiceSelect(value) {
            const select = document.createElement('select');
            select.className = 'service-select';
            // 加入 required 屬性，配合 CSS :invalid 讓顏色變淡
            select.required = true;
            select.onchange = updateAvailableOptions; 
            
            // ★★★ 1. 插入預設隱藏選項 ★★★
            const placeholder = new Option("請選擇服務項目", "");
            placeholder.disabled = true;
            placeholder.hidden = true;
            if (!value) placeholder.selected = true; // 若無值則預選此項
            select.add(placeholder);

            serviceOptions.forEach(opt => {
                const option = new Option(opt, opt);
                if (opt === "－") {
                    option.disabled = true; // 分隔線不可選
                }
                if (value && opt === value) option.selected = true;
                select.add(option);
            });
            return select;
        }

        function addServiceRow(selectedValue = null) {
            const container = document.getElementById('serviceContainer');
            const row = document.createElement('div');
            row.className = 'service-row';

            const select = createServiceSelect(selectedValue);
            row.appendChild(select);

            // 如果不是第一行，添加刪除按鈕
            if (container.children.length > 0) {
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn-remove';
                removeBtn.innerHTML = '×';
                removeBtn.onclick = function() { 
                    container.removeChild(row); 
                    // ★ 刪除後也要更新選項狀態 ★
                    updateAvailableOptions();
                };
                row.appendChild(removeBtn);
            }

            container.appendChild(row);
            // ★ 新增後更新選項狀態 ★
            updateAvailableOptions();
        }

        // ★★★ 核心邏輯：檢查並鎖定已選項目 (升級版) ★★★
        function updateAvailableOptions() {
            const selects = document.querySelectorAll('.service-select');
            
            // 收集目前所有已選的值 (不含空白)
            const allSelectedValues = Array.from(selects).map(s => s.value).filter(v => v);

            // 遍歷每一個選單來決定哪些選項該鎖定
            selects.forEach(sel => {
                const myValue = sel.value; // 自己當前選的值

                for (let i = 0; i < sel.options.length; i++) {
                    const opt = sel.options[i];
                    
                    // 跳過空白 placeholder 和分隔線
                    if (!opt.value || opt.value === "－") continue;

                    let shouldDisable = false;

                    // 規則 1: 已經被選走的，不能再選 (除非是自己選的)
                    if (allSelectedValues.includes(opt.value) && opt.value !== myValue) {
                        shouldDisable = true;
                    }

                    // 規則 2: 檢查互斥群組
                    if (!shouldDisable) {
                        for (const group of conflictGroups) {
                            // 如果這個選項屬於某個群組
                            if (group.includes(opt.value)) {
                                // 檢查已選項目中，是否包含「同群組」的其他項目 (排除自己)
                                const conflictFound = allSelectedValues.some(val => val !== myValue && group.includes(val));
                                if (conflictFound) {
                                    shouldDisable = true;
                                    break; // 只要撞到一個規則就鎖定，不用繼續查
                                }
                            }
                        }
                    }

                    // 執行鎖定或解鎖
                    if (shouldDisable) {
                        opt.disabled = true; 
                        opt.style.display = 'none'; // 隱藏
                    } else {
                        opt.disabled = false;
                        opt.style.display = ''; // 顯示
                    }
                }
            });
        }

        function getSelectedServices() {
            const selects = document.querySelectorAll('.service-select');
            const values = [];
            selects.forEach(sel => {
                // ★★★ 3. 過濾空白值 ★★★
                if (sel.value) values.push(sel.value);
            });
            return values.join(" + "); 
        }

        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                mode: params.get('mode'),
                name: params.get('name'),
                service: params.get('service'),
                location: params.get('location'),
                time: params.get('time'),
                phone: params.get('phone'),
                status: params.get('status')
            };
        }
        let currentParams = {}; 

        window.onload = function() {
            initTimeSlots();
            
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            const yyyy = tomorrow.getFullYear();
            const mm = String(tomorrow.getMonth() + 1).padStart(2, '0');
            const dd = String(tomorrow.getDate()).padStart(2, '0');
            const tomorrowStr = `${yyyy}-${mm}-${dd}`;
            const dateInput = document.getElementById('inputDate');
            dateInput.value = tomorrowStr; 
            dateInput.min = tomorrowStr;
            dateInput.addEventListener('change', function() {
                if (this.value < tomorrowStr) {
                    alert("請選擇明天以後的日期");
                    this.value = tomorrowStr; 
                }
            });
            initializeLiff();
        };

        function initializeLiff() {
            liff.init({ liffId: YOUR_LIFF_ID }).then(() => {
                document.getElementById('loading-status').style.display = 'none';
                if (!liff.isLoggedIn()) liff.login();
                else handlePageLogic();
            }).catch((err) => {
                document.getElementById('loading-status').innerText = "初始化失敗";
                console.error(err);
            });
        }

        function handlePageLogic() {
            liff.getProfile().then(profile => {
                document.getElementById('userName').innerText = profile.displayName;
                document.getElementById('inputName').value = profile.displayName;
                document.getElementById('userIdText').innerText = profile.userId;
                const img = document.getElementById('userPicture');
                img.src = profile.pictureUrl ? profile.pictureUrl : "https://via.placeholder.com/80";

                currentParams = getQueryParams();
                
                const container = document.getElementById('serviceContainer');
                container.innerHTML = '';

                if (currentParams.mode === 'view') {
                    // --- 顯示詳情模式 ---
                    document.getElementById('booking-form-section').style.display = 'none';
                    document.getElementById('booking-details-section').style.display = 'block';

                    document.getElementById('viewName').innerText = currentParams.name || profile.displayName;
                    document.getElementById('viewService').innerText = (currentParams.service || "未指定").replace(/ \+ /g, "\n");
                    document.getElementById('viewLocation').innerText = currentParams.location || "未指定";
                    document.getElementById('viewTime').innerText = currentParams.time || "未指定";

                    if (currentParams.status === 'SUCCESS') document.getElementById('btn-modify-booking').style.display = 'none';
                    else document.getElementById('btn-modify-booking').style.display = 'inline-block';

                    document.getElementById('inputName').value = currentParams.name || profile.displayName;
                    
                    if (currentParams.service) {
                        const services = currentParams.service.split(' + ');
                        services.forEach(svc => addServiceRow(svc.trim()));
                    } else {
                        addServiceRow();
                    }

                    if(currentParams.location) document.getElementById('inputLocation').value = currentParams.location;
                    if(currentParams.phone) document.getElementById('inputPhone').value = currentParams.phone;
                    if(currentParams.time && currentParams.time.includes(' ')) {
                        const parts = currentParams.time.split(' ');
                        document.getElementById('inputDate').value = parts[0].replace(/\//g, '-');
                        document.getElementById('inputTime').value = parts[1];
                    }
                } else {
                    // --- 正常預約模式 ---
                    document.getElementById('booking-form-section').style.display = 'block';
                    document.getElementById('booking-details-section').style.display = 'none';
                    addServiceRow(); 
                    enableAllFields();
                }
            }).catch(err => console.error('Profile Error:', err));
        }

        function switchToEditMode() {
            document.getElementById('booking-details-section').style.display = 'none';
            document.getElementById('booking-form-section').style.display = 'block';
            
            document.getElementById('inputName').disabled = true;
            document.getElementById('inputPhone').disabled = true;
            document.getElementById('inputLocation').disabled = true; 
            
            const selects = document.querySelectorAll('.service-select');
            selects.forEach(sel => sel.disabled = true);
            document.getElementById('btnAddService').style.display = 'none';
            const removeBtns = document.querySelectorAll('.btn-remove');
            removeBtns.forEach(btn => btn.style.display = 'none');

            document.getElementById('inputDate').disabled = false;
            document.getElementById('inputTime').disabled = false;
            document.getElementById('submitBtn').innerText = "確認修改預約";
        }

        function enableAllFields() {
            document.getElementById('inputName').disabled = false;
            document.getElementById('inputPhone').disabled = false;
            document.getElementById('inputLocation').disabled = false;
            document.getElementById('inputDate').disabled = false;
            document.getElementById('inputTime').disabled = false;
            
            const selects = document.querySelectorAll('.service-select');
            selects.forEach(sel => sel.disabled = false);
            document.getElementById('btnAddService').style.display = 'block';
            
            document.getElementById('submitBtn').innerText = "確認預約";
        }

        function submitBooking() {
            const name = document.getElementById('inputName').value;
            const phone = document.getElementById('inputPhone').value;
            const service = getSelectedServices(); 
            const location = document.getElementById('inputLocation').value;
            const date = document.getElementById('inputDate').value;
            const time = document.getElementById('inputTime').value;
            const userId = document.getElementById('userIdText').innerText;

            if(!name || !phone || !date || !service) { alert("請填寫完整資訊 (請選擇服務項目)"); return; }

            const today = new Date();
            today.setDate(today.getDate() + 1);
            const tomorrowStr = today.toISOString().split('T')[0];
            if (date < tomorrowStr) {
                alert("請選擇明天以後的日期");
                return;
            }

            if (!userId) {
                alert("系統尚未讀取到您的 UserID，請稍候再試或重新整理頁面。");
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerText = "資料傳送中...";

            const data = { name, phone, service, location, date, time, userId, secret: "Stelle2025Secure" };

            if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.startsWith('https://script.google.com')) {
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'text/plain' }
                }).then(() => console.log('Sent')).catch(err => console.error(err));
            } else {
                alert("系統錯誤：未設定後端網址");
                submitBtn.disabled = false;
                return;
            }

            if (liff.isInClient()) {
                liff.sendMessages([{ type: 'text', text: '我已送出預約' }])
                    .then(() => console.log("LINE 訊息發送成功"))
                    .catch((err) => {
                        alert("LINE 訊息發送失敗！\n原因：" + err.message + "\n請確認您是否允許了傳訊權限。");
                    });
            }

            showCustomModal(name, service, location, date, time);
            submitBtn.disabled = false;
            
            if(currentParams.mode === 'view') submitBtn.innerText = "確認修改預約";
            else submitBtn.innerText = "確認預約";
        }

        function showCustomModal(name, service, location, date, time) {
            document.getElementById('modalName').innerText = name;
            document.getElementById('modalService').innerText = service.replace(/ \+ /g, "\n");
            document.getElementById('modalLocation').innerText = location;
            document.getElementById('modalDate').innerText = date;
            document.getElementById('modalTime').innerText = time;
            document.getElementById('customModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('customModal').style.display = 'none';
            if (liff.isInClient()) liff.closeWindow();
        }
    </script>
</body>
</html>
